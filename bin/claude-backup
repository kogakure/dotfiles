#!/bin/bash

# claude-backup
# Backs up Claude Code configuration and project files to private/ submodule

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Directories
CLAUDE_DIR="$HOME/.claude"
BACKUP_DIR="$HOME/.dotfiles/private/claude"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo -e "${GREEN}Starting Claude Code backup...${NC}"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Function to backup a file if it exists
backup_file() {
    local src="$1"
    local dest="$2"

    if [ -f "$src" ]; then
        mkdir -p "$(dirname "$dest")"
        cp "$src" "$dest"
        echo -e "  ✓ Backed up: $(basename "$src")"
    else
        echo -e "  ${YELLOW}⊗ Not found: $(basename "$src")${NC}"
    fi
}

# Function to backup a directory if it exists
backup_dir() {
    local src="$1"
    local dest="$2"

    if [ -d "$src" ] && [ "$(ls -A "$src" 2>/dev/null)" ]; then
        mkdir -p "$(dirname "$dest")"
        rsync -a --delete "$src/" "$dest/"
        echo -e "  ✓ Backed up: $(basename "$src")/ ($(find "$src" -type f | wc -l | tr -d ' ') files)"
    else
        echo -e "  ${YELLOW}⊗ Not found or empty: $(basename "$src")/${NC}"
    fi
}

# Backup global settings
echo ""
echo "Backing up global settings..."
backup_file "$HOME/.claude.json" "$BACKUP_DIR/.claude.json"
backup_file "$CLAUDE_DIR/settings.json" "$BACKUP_DIR/settings.json"
backup_file "$CLAUDE_DIR/keybindings.json" "$BACKUP_DIR/keybindings.json"
backup_file "$CLAUDE_DIR/CLAUDE.md" "$BACKUP_DIR/CLAUDE.md"

# Backup history
echo ""
echo "Backing up history..."
backup_file "$CLAUDE_DIR/history.jsonl" "$BACKUP_DIR/history.jsonl"

# Backup stats
echo ""
echo "Backing up stats..."
backup_file "$CLAUDE_DIR/stats-cache.json" "$BACKUP_DIR/stats-cache.json"

# Backup commands directory
echo ""
echo "Backing up commands..."
backup_dir "$CLAUDE_DIR/commands" "$BACKUP_DIR/commands"

# Backup scripts directory
echo ""
echo "Backing up scripts..."
backup_dir "$CLAUDE_DIR/scripts" "$BACKUP_DIR/scripts"

# Backup plugins (excluding large marketplace directories, just config)
echo ""
echo "Backing up plugins configuration..."
backup_file "$CLAUDE_DIR/plugins/known_marketplaces.json" "$BACKUP_DIR/plugins/known_marketplaces.json"

# Backup project-specific configurations (CLAUDE.md, memory, etc.)
echo ""
echo "Backing up project configurations..."
if [ -d "$CLAUDE_DIR/projects" ]; then
    for project_dir in "$CLAUDE_DIR/projects"/*; do
        if [ -d "$project_dir" ]; then
            project_name=$(basename "$project_dir")

            # Backup .claude.json if exists
            if [ -f "$project_dir/.claude.json" ]; then
                backup_file "$project_dir/.claude.json" "$BACKUP_DIR/projects/$project_name/.claude.json"
            fi

            # Backup CLAUDE.md if exists
            if [ -f "$project_dir/CLAUDE.md" ]; then
                backup_file "$project_dir/CLAUDE.md" "$BACKUP_DIR/projects/$project_name/CLAUDE.md"
            fi

            # Backup memory directory if exists
            if [ -d "$project_dir/memory" ] && [ "$(ls -A "$project_dir/memory" 2>/dev/null)" ]; then
                backup_dir "$project_dir/memory" "$BACKUP_DIR/projects/$project_name/memory"
            fi

            # Backup hooks if they exist
            if [ -f "$project_dir/hooks.json" ]; then
                backup_file "$project_dir/hooks.json" "$BACKUP_DIR/projects/$project_name/hooks.json"
            fi
        fi
    done
fi

# Backup shell snapshots (useful for restoring context)
echo ""
echo "Backing up shell snapshots..."
if [ -d "$CLAUDE_DIR/shell-snapshots" ] && [ "$(ls -A "$CLAUDE_DIR/shell-snapshots" 2>/dev/null)" ]; then
    # Only backup the most recent snapshots (last 5)
    mkdir -p "$BACKUP_DIR/shell-snapshots"
    ls -t "$CLAUDE_DIR/shell-snapshots" | head -5 | while read -r file; do
        cp "$CLAUDE_DIR/shell-snapshots/$file" "$BACKUP_DIR/shell-snapshots/"
    done
    echo -e "  ✓ Backed up: shell-snapshots/ (latest 5 snapshots)"
else
    echo -e "  ${YELLOW}⊗ Not found or empty: shell-snapshots/${NC}"
fi

# Create a backup manifest
echo ""
echo "Creating backup manifest..."
cat > "$BACKUP_DIR/BACKUP_INFO.txt" <<EOF
Claude Code Backup
==================
Timestamp: $TIMESTAMP
Hostname: $(hostname)
Claude Dir: $CLAUDE_DIR

Backed up:
- Global settings (.claude.json, settings.json, keybindings.json)
- Global CLAUDE.md
- Command history (history.jsonl)
- Stats cache
- Commands directory
- Scripts directory
- Plugins configuration
- Project-specific configurations (.claude.json, CLAUDE.md, memory, hooks)
- Recent shell snapshots (last 5)

Note: Conversation history (.jsonl files in projects/) and debug logs
are excluded to keep backup size manageable.
EOF

echo -e "${GREEN}✓ Backup complete!${NC}"
echo -e "Backup location: $BACKUP_DIR"
echo ""
echo "To restore these settings on another machine, run: ./bin/claude-restore"
