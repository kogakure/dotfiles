#!/bin/bash

# claude-restore
# Restores Claude Code configuration from private/ submodule backup

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Directories
CLAUDE_DIR="$HOME/.claude"
BACKUP_DIR="$HOME/.dotfiles/private/claude"

echo -e "${GREEN}Starting Claude Code restore...${NC}"

# Check if backup exists
if [ ! -d "$BACKUP_DIR" ]; then
    echo -e "${RED}Error: Backup directory not found at $BACKUP_DIR${NC}"
    echo "Please run ./bin/claude-backup first or ensure private submodule is initialized."
    exit 1
fi

# Display backup info if available
if [ -f "$BACKUP_DIR/BACKUP_INFO.txt" ]; then
    echo ""
    echo -e "${YELLOW}Backup Information:${NC}"
    cat "$BACKUP_DIR/BACKUP_INFO.txt"
    echo ""
fi

# Prompt for confirmation
read -p "Do you want to restore Claude Code settings from backup? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Restore cancelled."
    exit 0
fi

# Create .claude directory if it doesn't exist
mkdir -p "$CLAUDE_DIR"

# Function to restore a file if it exists in backup
restore_file() {
    local src="$1"
    local dest="$2"

    if [ -f "$src" ]; then
        mkdir -p "$(dirname "$dest")"
        cp "$src" "$dest"
        echo -e "  ✓ Restored: $(basename "$dest")"
    else
        echo -e "  ${YELLOW}⊗ Not in backup: $(basename "$dest")${NC}"
    fi
}

# Function to restore a directory if it exists in backup
restore_dir() {
    local src="$1"
    local dest="$2"

    if [ -d "$src" ] && [ "$(ls -A "$src" 2>/dev/null)" ]; then
        mkdir -p "$dest"
        rsync -a "$src/" "$dest/"
        echo -e "  ✓ Restored: $(basename "$dest")/ ($(find "$src" -type f | wc -l | tr -d ' ') files)"
    else
        echo -e "  ${YELLOW}⊗ Not in backup: $(basename "$dest")/${NC}"
    fi
}

# Restore global settings
echo ""
echo "Restoring global settings..."
restore_file "$BACKUP_DIR/.claude.json" "$HOME/.claude.json"
restore_file "$BACKUP_DIR/settings.json" "$CLAUDE_DIR/settings.json"
restore_file "$BACKUP_DIR/keybindings.json" "$CLAUDE_DIR/keybindings.json"
restore_file "$BACKUP_DIR/CLAUDE.md" "$CLAUDE_DIR/CLAUDE.md"

# Restore history
echo ""
echo "Restoring history..."
restore_file "$BACKUP_DIR/history.jsonl" "$CLAUDE_DIR/history.jsonl"

# Restore stats
echo ""
echo "Restoring stats..."
restore_file "$BACKUP_DIR/stats-cache.json" "$CLAUDE_DIR/stats-cache.json"

# Restore commands directory
echo ""
echo "Restoring commands..."
restore_dir "$BACKUP_DIR/commands" "$CLAUDE_DIR/commands"

# Restore scripts directory
echo ""
echo "Restoring scripts..."
restore_dir "$BACKUP_DIR/scripts" "$CLAUDE_DIR/scripts"

# Restore plugins configuration
echo ""
echo "Restoring plugins configuration..."
restore_file "$BACKUP_DIR/plugins/known_marketplaces.json" "$CLAUDE_DIR/plugins/known_marketplaces.json"

# Restore project-specific configurations
echo ""
echo "Restoring project configurations..."
if [ -d "$BACKUP_DIR/projects" ]; then
    for project_backup in "$BACKUP_DIR/projects"/*; do
        if [ -d "$project_backup" ]; then
            project_name=$(basename "$project_backup")

            # Restore .claude.json
            if [ -f "$project_backup/.claude.json" ]; then
                restore_file "$project_backup/.claude.json" "$CLAUDE_DIR/projects/$project_name/.claude.json"
            fi

            # Restore CLAUDE.md
            if [ -f "$project_backup/CLAUDE.md" ]; then
                restore_file "$project_backup/CLAUDE.md" "$CLAUDE_DIR/projects/$project_name/CLAUDE.md"
            fi

            # Restore memory directory
            if [ -d "$project_backup/memory" ]; then
                restore_dir "$project_backup/memory" "$CLAUDE_DIR/projects/$project_name/memory"
            fi

            # Restore hooks
            if [ -f "$project_backup/hooks.json" ]; then
                restore_file "$project_backup/hooks.json" "$CLAUDE_DIR/projects/$project_name/hooks.json"
            fi
        fi
    done
fi

# Restore shell snapshots
echo ""
echo "Restoring shell snapshots..."
restore_dir "$BACKUP_DIR/shell-snapshots" "$CLAUDE_DIR/shell-snapshots"

echo ""
echo -e "${GREEN}✓ Restore complete!${NC}"
echo ""
echo "Claude Code settings have been restored from: $BACKUP_DIR"
echo "Restart Claude Code to apply all settings."
